<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="s4r’s hvm solution" /><meta property="og:locale" content="en" /><meta name="description" content="This is my old solution for s4r’s hvm crackme" /><meta property="og:description" content="This is my old solution for s4r’s hvm crackme" /><link rel="canonical" href="https://elvisblue.github.io/posts/hvm-solution/" /><meta property="og:url" content="https://elvisblue.github.io/posts/hvm-solution/" /><meta property="og:site_name" content="Elvis" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-06-17T09:19:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="s4r’s hvm solution" /><meta name="twitter:site" content="@DangDinhPhuong3" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-07-04T09:29:56+07:00","datePublished":"2023-06-17T09:19:00+07:00","description":"This is my old solution for s4r’s hvm crackme","headline":"s4r’s hvm solution","mainEntityOfPage":{"@type":"WebPage","@id":"https://elvisblue.github.io/posts/hvm-solution/"},"url":"https://elvisblue.github.io/posts/hvm-solution/"}</script><title>s4r's hvm solution | Elvis</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Elvis"><meta name="application-name" content="Elvis"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/commons/avatar.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><h1 class="site-title"> <a href="/">Elvis</a></h1><p class="site-subtitle fst-italic mb-0">A reverse engineer?</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ElvisBlue" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/DangDinhPhuong3" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/"> Home </a> </span> <span>s4r's hvm solution</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>s4r's hvm solution</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1686968340" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jun 17, 2023 </time> </span> <span> Updated <time data-ts="1720060196" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jul 4, 2024 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/ElvisBlue">Elvis</a> </em> </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="4378 words" > <em>24 min</em> read</span></div></div></header><div class="content"><p>This is my old solution for s4r’s hvm <a href="https://crackmes.one/crackme/614a591233c5d4649c52bbb1">crackme</a></p><h2 id="analyze-the-crackme"><span class="me-2">Analyze the crackme</span><a href="#analyze-the-crackme" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As the crackme’s description said that it’s a virtual machine (vm) one. Usually I will go quick while talking about reverse engineering the vm interpreter and will go into detail about vm ops code, what kind of vm, how does vm work,…. But this crackme worth to talk about the vm interpreter. The way crackme run the vm is very creative. It creates total 5 process with share vm memory. Each process will execute one vm instruction, then random pass the execution of next instruction to another process. By doing this crackme will make sure it run the vm code in 5 different process without changing the vm context. See image bellow</p><p><a href="/commons/2023-06-17-hvm-solution/image001.png" class="popup img-link shimmer"><img src="/commons/2023-06-17-hvm-solution/image001.png" alt="VM" loading="lazy"></a></p><p>Also the vm decrypt the vm code and vm context each time it start executing vm instruction. After it finish executing instruction, it encrypt vm code and vm context again. The image below show how does crackme encrypt vm code and vm context after finishing execute vm instruction</p><p><a href="/commons/2023-06-17-hvm-solution/image003.png" class="popup img-link shimmer"><img src="/commons/2023-06-17-hvm-solution/image003.png" alt="VM" loading="lazy"></a></p><p>The encryption is TEA with the keys is {<code class="language-plaintext highlighter-rouge">0xCAFEBABE</code>, <code class="language-plaintext highlighter-rouge">0xDEADBEEF</code>, <code class="language-plaintext highlighter-rouge">0xABAD1DEA</code>, <code class="language-plaintext highlighter-rouge">0xB19B00B5</code>}. Keys can be found at the vm init</p><p><a href="/commons/2023-06-17-hvm-solution/image005.png" class="popup img-link shimmer"><img src="/commons/2023-06-17-hvm-solution/image005.png" alt="VM" loading="lazy"></a></p><p>Here is the struct of the vm</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">SVMContext</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">reg</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">vmSP</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">vmIP</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
  <span class="n">DWORD</span> <span class="n">teaKey</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">bExit</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">SVM</span>
<span class="p">{</span>
  <span class="n">DWORD</span> <span class="n">vmMem</span><span class="p">[</span><span class="mi">786432</span><span class="p">];</span>
  <span class="n">SVMContext</span> <span class="n">vmContext</span><span class="p">;</span>
<span class="p">};</span>
</pre></table></code></div></div><p>Total size of vm struct is 0x301000. The details of vm struct are</p><ul><li>0x0 – 0x2FFFFF: vm memory<ul><li>0x0 – 0xFFFFF: vm code segment<li>0x100000 – 0x1FFFFF: vm stack segment<li>0x200000 – 0x2FFFFF: vm data segment</ul><li>0x30000 – 0x30FFF: vm context</ul><p>The vm ops code can be seen at the table below</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">Ops code<th style="text-align: left">Instruction<tbody><tr><td style="text-align: left">2<td style="text-align: left">jump<tr><td style="text-align: left">11<td style="text-align: left">je<tr><td style="text-align: left">12<td style="text-align: left">add<tr><td style="text-align: left">15<td style="text-align: left">exit<tr><td style="text-align: left">17<td style="text-align: left">sub<tr><td style="text-align: left">12<td style="text-align: left">mov<tr><td style="text-align: left">23<td style="text-align: left">not<tr><td style="text-align: left">24<td style="text-align: left">xor<tr><td style="text-align: left">25<td style="text-align: left">shl<tr><td style="text-align: left">26<td style="text-align: left">mod<tr><td style="text-align: left">27<td style="text-align: left">and<tr><td style="text-align: left">31<td style="text-align: left">or<tr><td style="text-align: left">32<td style="text-align: left">call<tr><td style="text-align: left">33<td style="text-align: left">ret<tr><td style="text-align: left">34<td style="text-align: left">shr<tr><td style="text-align: left">35<td style="text-align: left">cmp<tr><td style="text-align: left">37<td style="text-align: left">get mem<tr><td style="text-align: left">38<td style="text-align: left">pop<tr><td style="text-align: left">42<td style="text-align: left">set mem<tr><td style="text-align: left">54<td style="text-align: left">push<tr><td style="text-align: left">57<td style="text-align: left">jne</table></div><p>Here is a sample of add handler (code perform instruction <code class="language-plaintext highlighter-rouge">add</code>)</p><p><a href="/commons/2023-06-17-hvm-solution/image006.png" class="popup img-link shimmer"><img src="/commons/2023-06-17-hvm-solution/image006.png" alt="VM" loading="lazy"></a></p><h2 id="analyze-the-vm"><span class="me-2">Analyze the VM</span><a href="#analyze-the-vm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>If the password length is 16, it will be copied to vm memory at offset 0x210000 then run the vm. To analyze the vm, we need to dump the vm memory (which include all necessary data such as password, vm data and vm code) then write a disassembler to analyze it. To dump the vm memory, just debugging it and dump the memory before it execute any vm instruction. You can find my dump <a href="/commons/2023-06-17-hvm-solution/VM_Mem.bin">here</a>. There are many options to write a dissembler such as using C, python,… but in this case I wrote a small IDA processor to dissamble the vm code.</p><details> <summary><b>Click here to expand IDA Processor</b></summary><div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">idc</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">idautils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">idaapi</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">hvm_processor_t</span><span class="p">(</span><span class="n">processor_t</span><span class="p">):</span>
	<span class="nb">id</span> <span class="o">=</span> <span class="mh">0x8000</span> <span class="o">+</span> <span class="mi">1212</span>
	<span class="n">flag</span> <span class="o">=</span> <span class="n">PR_ASSEMBLE</span> <span class="o">|</span> <span class="n">PRN_HEX</span> 
	<span class="n">cnbits</span> <span class="o">=</span> <span class="mi">8</span>
	<span class="n">dnbits</span> <span class="o">=</span> <span class="mi">32</span>
	<span class="n">psnames</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">hvm</span><span class="sh">"</span><span class="p">]</span>
	<span class="n">plnames</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">HVM Processor</span><span class="sh">"</span><span class="p">]</span>
	<span class="n">segreg_size</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">instruc_start</span> <span class="o">=</span> <span class="mi">0</span>
	
	<span class="n">assembler</span> <span class="o">=</span> <span class="p">{</span>
		<span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">.hvm</span><span class="sh">"</span><span class="p">],</span>
		<span class="sh">"</span><span class="s">flag</span><span class="sh">"</span><span class="p">:</span> <span class="n">AS_NCHRE</span> <span class="o">|</span> <span class="n">ASH_HEXF0</span> <span class="o">|</span> <span class="n">ASD_DECF0</span> <span class="o">|</span> <span class="n">ASO_OCTF0</span> <span class="o">|</span> <span class="n">ASB_BINF0</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">uflag</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">hvm assembler</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">origin</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.org</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">end</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.end</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">cmnt</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">ascsep</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"'"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">accsep</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"'"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">esccodes</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="se">\"</span><span class="sh">'"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_ascii</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.ascii</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_byte</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.byte</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_word</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.word</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_dword</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.dword</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_bss</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dfs %s</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_seg</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">seg</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_curip</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">PC</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_public</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_weak</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_extrn</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.extern</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_comdef</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_align</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.align</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">lbrace</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">(</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">rbrace</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">)</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_mod</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">%</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_band</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">&amp;</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_bor</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">|</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_xor</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">^</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_bnot</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_shl</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">&lt;&lt;</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_shr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">&gt;&gt;</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">a_sizeof_fmt</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">size %s</span><span class="sh">"</span><span class="p">,</span>
	<span class="p">}</span>
	
	
	<span class="c1"># size of a segment register in bytes
</span>	<span class="n">segreg_size</span> <span class="o">=</span> <span class="mi">0</span>
	
	<span class="n">reg_names</span> <span class="o">=</span> <span class="p">[</span>
	  <span class="sh">'</span><span class="s">r0</span><span class="sh">'</span><span class="p">,</span>
	  <span class="sh">'</span><span class="s">r1</span><span class="sh">'</span><span class="p">,</span>
	  <span class="sh">'</span><span class="s">r2</span><span class="sh">'</span><span class="p">,</span>
	  <span class="sh">'</span><span class="s">r3</span><span class="sh">'</span><span class="p">,</span>
	  <span class="sh">'</span><span class="s">r4</span><span class="sh">'</span><span class="p">,</span>
	  <span class="sh">'</span><span class="s">r5</span><span class="sh">'</span><span class="p">,</span>
	  <span class="sh">'</span><span class="s">r6</span><span class="sh">'</span><span class="p">,</span>
	  <span class="sh">'</span><span class="s">sp</span><span class="sh">'</span><span class="p">,</span>
	<span class="p">]</span>
	
	<span class="c1"># Array of instructions
</span>	<span class="n">instruc</span> <span class="o">=</span> <span class="p">[</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">jmp</span><span class="sh">'</span><span class="p">,</span>     <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_JUMP</span> <span class="o">|</span> <span class="n">CF_USE1</span><span class="p">,</span>        <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Unconditional jump</span><span class="sh">"</span><span class="p">},</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">je</span><span class="sh">'</span><span class="p">,</span>      <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_JUMP</span> <span class="o">|</span> <span class="n">CF_USE1</span><span class="p">,</span>        <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Jump if flag set to 1</span><span class="sh">"</span><span class="p">},</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">add</span><span class="sh">'</span><span class="p">,</span>     <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_USE1</span> <span class="o">|</span> <span class="n">CF_USE2</span><span class="p">,</span>        <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Add</span><span class="sh">"</span><span class="p">},</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">exit</span><span class="sh">'</span><span class="p">,</span>    <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_STOP</span><span class="p">,</span>                  <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Exit program</span><span class="sh">"</span><span class="p">},</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">sub</span><span class="sh">'</span><span class="p">,</span>     <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_USE1</span> <span class="o">|</span> <span class="n">CF_USE2</span><span class="p">,</span>        <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Sub</span><span class="sh">"</span><span class="p">},</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">mov</span><span class="sh">'</span><span class="p">,</span>     <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_USE1</span> <span class="o">|</span> <span class="n">CF_USE2</span><span class="p">,</span>        <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Mov</span><span class="sh">"</span><span class="p">},</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">not</span><span class="sh">'</span><span class="p">,</span>     <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_USE1</span><span class="p">,</span>                  <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Not</span><span class="sh">"</span><span class="p">},</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">xor</span><span class="sh">'</span><span class="p">,</span>     <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_USE1</span> <span class="o">|</span> <span class="n">CF_USE2</span><span class="p">,</span>        <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Xor</span><span class="sh">"</span><span class="p">},</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">shl</span><span class="sh">'</span><span class="p">,</span>     <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_USE1</span> <span class="o">|</span> <span class="n">CF_USE2</span><span class="p">,</span>        <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Shl</span><span class="sh">"</span><span class="p">},</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">mod</span><span class="sh">'</span><span class="p">,</span>     <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_USE1</span> <span class="o">|</span> <span class="n">CF_USE2</span><span class="p">,</span>        <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Mod</span><span class="sh">"</span><span class="p">},</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">and</span><span class="sh">'</span><span class="p">,</span>     <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_USE1</span> <span class="o">|</span> <span class="n">CF_USE2</span><span class="p">,</span>        <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">And</span><span class="sh">"</span><span class="p">},</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">or</span><span class="sh">'</span><span class="p">,</span>      <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_USE1</span> <span class="o">|</span> <span class="n">CF_USE2</span><span class="p">,</span>        <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Or</span><span class="sh">"</span><span class="p">},</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">call</span><span class="sh">'</span><span class="p">,</span>    <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_CALL</span> <span class="o">|</span> <span class="n">CF_USE1</span><span class="p">,</span>        <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Call</span><span class="sh">"</span><span class="p">},</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">ret</span><span class="sh">'</span><span class="p">,</span>     <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_STOP</span><span class="p">,</span>                  <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Ret</span><span class="sh">"</span><span class="p">},</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">shr</span><span class="sh">'</span><span class="p">,</span>     <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_USE1</span> <span class="o">|</span> <span class="n">CF_USE2</span><span class="p">,</span>        <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Shr</span><span class="sh">"</span><span class="p">},</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">cmp</span><span class="sh">'</span><span class="p">,</span>     <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_USE1</span> <span class="o">|</span> <span class="n">CF_USE2</span><span class="p">,</span>        <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Cmp</span><span class="sh">"</span><span class="p">},</span>
		<span class="c1">#{'name': 'mov',     'feature':0,                       'cmt': "Get memory"},
</span>		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">pop</span><span class="sh">'</span><span class="p">,</span>     <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_USE1</span><span class="p">,</span>                  <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Pop</span><span class="sh">"</span><span class="p">},</span>
		<span class="c1">#{'name': 'mov',     'feature':0,                       'cmt': "Set memory"},
</span>		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">push</span><span class="sh">'</span><span class="p">,</span>    <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_USE1</span><span class="p">,</span>                  <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Push register</span><span class="sh">"</span><span class="p">},</span>
		<span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">jne</span><span class="sh">'</span><span class="p">,</span>     <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span><span class="n">CF_JUMP</span> <span class="o">|</span> <span class="n">CF_USE1</span><span class="p">,</span>        <span class="sh">'</span><span class="s">cmt</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Jump if flag set to 0</span><span class="sh">"</span><span class="p">},</span>
	<span class="p">]</span>
	
	<span class="n">instruc_idx</span> <span class="o">=</span> <span class="p">{</span>
		<span class="sh">'</span><span class="s">jmp</span><span class="sh">'</span>   <span class="p">:</span>   <span class="mi">0</span><span class="p">,</span> 
		<span class="sh">'</span><span class="s">je</span><span class="sh">'</span>    <span class="p">:</span>   <span class="mi">1</span><span class="p">,</span> 
		<span class="sh">'</span><span class="s">add</span><span class="sh">'</span>   <span class="p">:</span>   <span class="mi">2</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">exit</span><span class="sh">'</span>  <span class="p">:</span>   <span class="mi">3</span><span class="p">,</span> 
		<span class="sh">'</span><span class="s">sub</span><span class="sh">'</span>   <span class="p">:</span>   <span class="mi">4</span><span class="p">,</span> 
		<span class="sh">'</span><span class="s">mov</span><span class="sh">'</span>   <span class="p">:</span>   <span class="mi">5</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">not</span><span class="sh">'</span>   <span class="p">:</span>   <span class="mi">6</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">xor</span><span class="sh">'</span>   <span class="p">:</span>   <span class="mi">7</span><span class="p">,</span> 
		<span class="sh">'</span><span class="s">shl</span><span class="sh">'</span>   <span class="p">:</span>   <span class="mi">8</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">mod</span><span class="sh">'</span>   <span class="p">:</span>   <span class="mi">9</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">and</span><span class="sh">'</span>   <span class="p">:</span>   <span class="mi">10</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">or</span><span class="sh">'</span>    <span class="p">:</span>   <span class="mi">11</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">call</span><span class="sh">'</span>  <span class="p">:</span>   <span class="mi">12</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">ret</span><span class="sh">'</span>   <span class="p">:</span>   <span class="mi">13</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">shr</span><span class="sh">'</span>   <span class="p">:</span>   <span class="mi">14</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">cmp</span><span class="sh">'</span>   <span class="p">:</span>   <span class="mi">15</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">pop</span><span class="sh">'</span>   <span class="p">:</span>   <span class="mi">16</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">push</span><span class="sh">'</span>  <span class="p">:</span>   <span class="mi">17</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">jne</span><span class="sh">'</span>   <span class="p">:</span>   <span class="mi">18</span><span class="p">,</span>
	<span class="p">}</span>
	
	<span class="c1"># icode of the first instruction
</span>	<span class="n">instruc_start</span> <span class="o">=</span> <span class="mi">0</span>

	<span class="c1"># icode of the last instruction + 1
</span>	<span class="n">instruc_end</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">instruc</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
	
	<span class="c1"># Segment register information (use virtual CS and DS registers if your
</span>	<span class="c1"># processor doesn't have segment registers):
</span>	<span class="n">reg_first_sreg</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># index of CS
</span>	<span class="n">reg_last_sreg</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># index of DS
</span>
	<span class="c1"># You should define 2 virtual segment registers for CS and DS.
</span>	<span class="c1"># number of CS/DS registers
</span>	<span class="n">reg_code_sreg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
	<span class="n">reg_data_sreg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
		
		
	
	<span class="k">def</span> <span class="nf">get_reg</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
		<span class="nf">return </span><span class="p">(</span><span class="n">op</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span>
		
	<span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ea</span><span class="p">,</span> <span class="n">op_cmd</span><span class="p">):</span>
		<span class="nf">if </span><span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
			<span class="n">op_cmd</span><span class="p">.</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_imm</span>
			<span class="n">op_cmd</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="nf">get_wide_dword</span><span class="p">(</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">op_cmd</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="nf">get_wide_dword</span><span class="p">(</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">op_cmd</span><span class="p">.</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_reg</span>
			<span class="n">op_cmd</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span>
		<span class="k">return</span> <span class="bp">True</span>
		
	<span class="k">def</span> <span class="nf">get_mem</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ea</span><span class="p">,</span> <span class="n">op_cmd</span><span class="p">):</span>
		<span class="nf">if </span><span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
			<span class="n">op_cmd</span><span class="p">.</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_phrase</span> <span class="c1">#address memory
</span>			<span class="n">op_cmd</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="nf">get_wide_dword</span><span class="p">(</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">op_cmd</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="nf">get_wide_dword</span><span class="p">(</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">op_cmd</span><span class="p">.</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_displ</span> <span class="c1">#reg memory
</span>			<span class="n">op_cmd</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span>
		<span class="k">return</span> <span class="bp">True</span>
		

	<span class="k">def</span> <span class="nf">get_instruction_itype</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">instruc_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> 
		<span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">ret</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Could not find instruction %s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

	<span class="k">def</span> <span class="nf">get_instruction_name</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">itype</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ins</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">instruc</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">itype</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">ins</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span>
					
	<span class="k">def</span> <span class="nf">notify_func_bounds</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">func_ea</span><span class="p">,</span> <span class="n">max_func_end_ea</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">FIND_FUNC_OK</span>

	<span class="k">def</span> <span class="nf">notify_out_operand</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">op</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">o_imm</span><span class="p">:</span>
			<span class="n">ctx</span><span class="p">.</span><span class="nf">out_value</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">OOFW_32</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">op</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">o_near</span><span class="p">:</span>
			<span class="n">ctx</span><span class="p">.</span><span class="nf">out_name_expr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">op</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">op</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">o_phrase</span><span class="p">:</span>
			<span class="n">ctx</span><span class="p">.</span><span class="nf">out_symbol</span><span class="p">(</span><span class="sh">"</span><span class="s">[</span><span class="sh">"</span><span class="p">)</span>
			<span class="n">ctx</span><span class="p">.</span><span class="nf">out_name_expr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">op</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span>
			<span class="n">ctx</span><span class="p">.</span><span class="nf">out_symbol</span><span class="p">(</span><span class="sh">"</span><span class="s">]</span><span class="sh">"</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">op</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">o_displ</span><span class="p">:</span>
			<span class="n">ctx</span><span class="p">.</span><span class="nf">out_symbol</span><span class="p">(</span><span class="sh">"</span><span class="s">[</span><span class="sh">"</span><span class="p">)</span>
			<span class="n">ctx</span><span class="p">.</span><span class="nf">out_register</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">reg_names</span><span class="p">[</span><span class="n">op</span><span class="p">.</span><span class="n">reg</span><span class="p">])</span>
			<span class="n">ctx</span><span class="p">.</span><span class="nf">out_symbol</span><span class="p">(</span><span class="sh">"</span><span class="s">]</span><span class="sh">"</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">op</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">o_reg</span><span class="p">:</span>
			<span class="n">ctx</span><span class="p">.</span><span class="nf">out_register</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">reg_names</span><span class="p">[</span><span class="n">op</span><span class="p">.</span><span class="n">reg</span><span class="p">])</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">False</span>
		<span class="k">return</span> <span class="bp">True</span>
			
	<span class="k">def</span> <span class="nf">notify_out_insn</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
		<span class="n">ctx</span><span class="p">.</span><span class="nf">out_line</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_name</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">insn</span><span class="p">.</span><span class="n">itype</span><span class="p">))</span>
		
		<span class="n">feature</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">insn</span><span class="p">.</span><span class="nf">get_canon_feature</span><span class="p">()</span>
		
		<span class="n">ctx</span><span class="p">.</span><span class="nf">out_spaces</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
		
		<span class="k">if</span> <span class="n">feature</span> <span class="o">&amp;</span> <span class="n">CF_USE1</span><span class="p">:</span>
			<span class="n">ctx</span><span class="p">.</span><span class="nf">out_one_operand</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		
		<span class="k">if</span> <span class="n">feature</span> <span class="o">&amp;</span> <span class="n">CF_USE2</span><span class="p">:</span>
			<span class="n">ctx</span><span class="p">.</span><span class="nf">out_char</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)</span>
			<span class="n">ctx</span><span class="p">.</span><span class="nf">out_char</span><span class="p">(</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
			<span class="n">ctx</span><span class="p">.</span><span class="nf">out_one_operand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

		<span class="n">ctx</span><span class="p">.</span><span class="nf">flush_outbuf</span><span class="p">()</span>
		<span class="k">return</span>
			
	<span class="k">def</span> <span class="nf">notify_emu</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
		<span class="n">feature</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="nf">get_canon_feature</span><span class="p">()</span>

		<span class="c1">#Analyze instruction to make ref
</span>		<span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">instruc</span><span class="p">[</span><span class="n">cmd</span><span class="p">.</span><span class="n">itype</span><span class="p">][</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">'</span><span class="s">je</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">jne</span><span class="sh">'</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">!=</span> <span class="n">o_reg</span><span class="p">:</span>
				<span class="nf">add_cref</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">fl_JN</span><span class="p">)</span>
			<span class="n">flows</span> <span class="o">=</span> <span class="p">(</span><span class="n">feature</span> <span class="o">&amp;</span> <span class="n">CF_STOP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="k">if</span> <span class="n">flows</span><span class="p">:</span>
				<span class="nf">add_cref</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">fl_F</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">instruc</span><span class="p">[</span><span class="n">cmd</span><span class="p">.</span><span class="n">itype</span><span class="p">][</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">call</span><span class="sh">'</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
				<span class="nf">add_cref</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">fl_CN</span><span class="p">)</span>
			<span class="n">flows</span> <span class="o">=</span> <span class="p">(</span><span class="n">feature</span> <span class="o">&amp;</span> <span class="n">CF_STOP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="k">if</span> <span class="n">flows</span><span class="p">:</span>
				<span class="nf">add_cref</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">fl_F</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">instruc</span><span class="p">[</span><span class="n">cmd</span><span class="p">.</span><span class="n">itype</span><span class="p">][</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">jmp</span><span class="sh">'</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">!=</span> <span class="n">o_reg</span><span class="p">:</span>
				<span class="nf">add_cref</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">fl_JN</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">flows</span> <span class="o">=</span> <span class="p">(</span><span class="n">feature</span> <span class="o">&amp;</span> <span class="n">CF_STOP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="k">if</span> <span class="n">flows</span><span class="p">:</span>
				<span class="nf">add_cref</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">fl_F</span><span class="p">)</span>
				
		<span class="k">return</span> <span class="bp">True</span>

	<span class="k">def</span> <span class="nf">notify_ana</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
		<span class="n">optype</span> <span class="o">=</span> <span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">)</span>
		
		<span class="k">if</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1">#jump
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">jmp</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_value</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">==</span> <span class="n">o_imm</span><span class="p">:</span>
				<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_near</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">11</span><span class="p">:</span> <span class="c1">#je
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">je</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_value</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">==</span> <span class="n">o_imm</span><span class="p">:</span>
				<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_near</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span> <span class="c1">#Add register
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">add</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_reg</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_reg</span><span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_value</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span> <span class="c1">#Exit
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">exit</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">17</span><span class="p">:</span> <span class="c1">#Sub
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">sub</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_reg</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_reg</span><span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_value</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">22</span><span class="p">:</span> <span class="c1">#mov reg, value
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">mov</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_reg</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_reg</span><span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_value</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">23</span><span class="p">:</span> <span class="c1">#not
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">not</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_reg</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_reg</span><span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_value</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">24</span><span class="p">:</span> <span class="c1">#xor
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">xor</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_reg</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_reg</span><span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_value</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">25</span><span class="p">:</span> <span class="c1">#shl
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">shl</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_reg</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_reg</span><span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_value</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">26</span><span class="p">:</span> <span class="c1">#mod
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">mod</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_reg</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_reg</span><span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_value</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">27</span><span class="p">:</span> <span class="c1">#and
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">and</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_reg</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_reg</span><span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_value</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">31</span><span class="p">:</span> <span class="c1">#or
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">or</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_reg</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_reg</span><span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_value</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span> <span class="c1">#call
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">call</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_value</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">==</span> <span class="n">o_imm</span><span class="p">:</span>
				<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_near</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">33</span><span class="p">:</span> <span class="c1">#ret
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">ret</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">34</span><span class="p">:</span> <span class="c1">#shr
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">shr</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_reg</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_reg</span><span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_value</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">35</span><span class="p">:</span> <span class="c1">#cmp
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">cmp</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_reg</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_reg</span><span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_value</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">37</span><span class="p">:</span> <span class="c1">#Get mem
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">mov</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_reg</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_reg</span><span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_mem</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">38</span><span class="p">:</span> <span class="c1">#pop reg
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">pop</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_reg</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_reg</span><span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">42</span><span class="p">:</span> <span class="c1">#set mem
</span>			<span class="c1">#This is going to be weird to implement
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">mov</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_mem</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_reg</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">reg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_reg</span><span class="p">(</span><span class="nf">get_wide_byte</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="c1">#swap reg and value
</span>			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">reg</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span>
			<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span>

		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">54</span><span class="p">:</span> <span class="c1">#push
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">push</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_value</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">optype</span> <span class="o">==</span> <span class="mi">57</span><span class="p">:</span> <span class="c1">#jne
</span>			<span class="n">cmd</span><span class="p">.</span><span class="n">itype</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_instruction_itype</span><span class="p">(</span><span class="sh">'</span><span class="s">jne</span><span class="sh">'</span><span class="p">)</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">get_value</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">==</span> <span class="n">o_imm</span><span class="p">:</span>
				<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">=</span> <span class="n">o_near</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Unknown instruction %X</span><span class="sh">"</span> <span class="o">%</span> <span class="n">optype</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cmd</span><span class="p">.</span><span class="n">size</span>
	
<span class="k">def</span> <span class="nf">PROCESSOR_ENTRY</span><span class="p">():</span>
	<span class="k">return</span> <span class="nf">hvm_processor_t</span><span class="p">()</span>
</pre></table></code></div></div></div></details><p><br /></p><p>But wait, it doesn’t disasamble the code correctly.</p><p><a href="/commons/2023-06-17-hvm-solution/image008.png" class="popup img-link shimmer"><img src="/commons/2023-06-17-hvm-solution/image008.png" alt="VM" loading="lazy"></a></p><p>That’s because the vm code is still encrypted by TEA. I wrote a small script to decrypt the vm code.</p><details> <summary><b>Click here to expand decrypting script</b></summary><div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">idaapi</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="n">base64</span>
<span class="kn">import</span> <span class="n">ctypes</span>
<span class="kn">import</span> <span class="n">itertools</span>
<span class="kn">import</span> <span class="n">math</span>
<span class="kn">import</span> <span class="n">struct</span>
<span class="kn">import</span> <span class="n">hexdump</span>

<span class="c1">#TEA decryption was taken from https://gist.github.com/twheys/4e83567942172f8ba85058fae6bfeef5
</span><span class="k">def</span> <span class="nf">_chunks</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">it</span> <span class="o">=</span> <span class="nf">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="nf">tuple</span><span class="p">(</span><span class="n">itertools</span><span class="p">.</span><span class="nf">islice</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">yield</span> <span class="n">chunk</span>
        
<span class="k">def</span> <span class="nf">_str2vec</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># Split the string into chunks
</span>    <span class="n">num_chunks</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">ceil</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">l</span><span class="p">)</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="n">l</span> <span class="o">*</span> <span class="n">i</span><span class="p">:</span><span class="n">l</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_chunks</span><span class="p">)]</span>

    <span class="k">return</span> <span class="p">[</span><span class="nf">sum</span><span class="p">([</span><span class="n">character</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">j</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">character</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">chunk</span><span class="p">)])</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">]</span>
            
<span class="k">def</span> <span class="nf">_vec2str</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="c1">#Modified to work
</span>    <span class="n">ret</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">""</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">vector</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">I</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>
                 
<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="c1">#Modified to work
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">ciphertext</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">''</span>

    <span class="n">k</span> <span class="o">=</span> <span class="nf">_str2vec</span><span class="p">(</span><span class="n">key</span><span class="p">[:</span><span class="mi">16</span><span class="p">])</span>
    <span class="n">v</span> <span class="o">=</span> <span class="nf">_str2vec</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>

    <span class="k">return</span> <span class="sa">b</span><span class="sh">''</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">_vec2str</span><span class="p">(</span><span class="nf">_decipher</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nf">_chunks</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    
<span class="k">def</span> <span class="nf">_decipher</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="p">.</span><span class="nf">c_uint32</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="nb">sum</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">c_uint32</span><span class="p">(</span><span class="mh">0xC6EF3720</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="mh">0x9E3779B9</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">z</span><span class="p">.</span><span class="n">value</span> <span class="o">-=</span> <span class="p">(</span><span class="n">y</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">^</span> <span class="n">y</span><span class="p">.</span><span class="n">value</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">.</span><span class="n">value</span> <span class="o">^</span> <span class="p">(</span><span class="n">y</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">y</span><span class="p">.</span><span class="n">value</span> <span class="o">-=</span> <span class="p">(</span><span class="n">z</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">z</span><span class="p">.</span><span class="n">value</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">.</span><span class="n">value</span> <span class="o">^</span> <span class="p">(</span><span class="n">z</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">sum</span><span class="p">.</span><span class="n">value</span> <span class="o">-=</span> <span class="n">delta</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">y</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">z</span><span class="p">.</span><span class="n">value</span><span class="p">]</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nf">get_bytes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0xC70</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">IIII</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0xCAFEBABE</span><span class="p">,</span> <span class="mh">0xDEADBEEF</span><span class="p">,</span> <span class="mh">0xABAD1DEA</span><span class="p">,</span> <span class="mh">0xB19B00B5</span><span class="p">)</span>
    <span class="n">decoded_data</span> <span class="o">=</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="n">hexdump</span><span class="p">.</span><span class="nf">hexdump</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">)</span>
    <span class="nf">patch_bytes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">)</span>
    
</pre></table></code></div></div></div></details><p><br /></p><p>The result is very satisfying.</p><p><a href="/commons/2023-06-17-hvm-solution/image010.png" class="popup img-link shimmer"><img src="/commons/2023-06-17-hvm-solution/image010.png" alt="VM" loading="lazy"></a></p><p>IDA even give us a beautiful graph</p><p><a href="/commons/2023-06-17-hvm-solution/image012.png" class="popup img-link shimmer"><img src="/commons/2023-06-17-hvm-solution/image012.png" alt="VM" loading="lazy"></a></p><p>Almost done. There is still one thing: The obfuscation with <code class="language-plaintext highlighter-rouge">add</code> instruction as you can see in the image. I also wrote a small script to solve this little problem</p><details> <summary><b>Click here to expand helper script</b></summary><div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">idc</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">idautils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">idaapi</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">reg_names</span> <span class="o">=</span> <span class="p">[</span>
      <span class="sh">'</span><span class="s">r0</span><span class="sh">'</span><span class="p">,</span>
      <span class="sh">'</span><span class="s">r1</span><span class="sh">'</span><span class="p">,</span>
      <span class="sh">'</span><span class="s">r2</span><span class="sh">'</span><span class="p">,</span>
      <span class="sh">'</span><span class="s">r3</span><span class="sh">'</span><span class="p">,</span>
      <span class="sh">'</span><span class="s">r4</span><span class="sh">'</span><span class="p">,</span>
      <span class="sh">'</span><span class="s">r5</span><span class="sh">'</span><span class="p">,</span>
      <span class="sh">'</span><span class="s">r6</span><span class="sh">'</span><span class="p">,</span>
      <span class="sh">'</span><span class="s">sp</span><span class="sh">'</span><span class="p">,</span>
    <span class="p">]</span>
    
<span class="k">def</span> <span class="nf">comment_add</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">func_ea</span> <span class="ow">in</span> <span class="nc">Functions</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0C66</span><span class="p">):</span>
        <span class="nf">for </span><span class="p">(</span><span class="n">start_ea</span><span class="p">,</span> <span class="n">end_ea</span><span class="p">)</span> <span class="ow">in</span> <span class="nc">Chunks</span><span class="p">(</span><span class="n">func_ea</span><span class="p">):</span>
            <span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">head</span> <span class="ow">in</span> <span class="nc">Heads</span><span class="p">(</span><span class="n">start_ea</span><span class="p">,</span> <span class="n">end_ea</span><span class="p">):</span>
                <span class="n">insn</span> <span class="o">=</span> <span class="nc">DecodeInstruction</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">insn</span><span class="p">.</span><span class="n">itype</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">insn</span><span class="p">.</span><span class="n">Op1</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">o_reg</span> <span class="ow">and</span> <span class="n">insn</span><span class="p">.</span><span class="n">Op2</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">o_imm</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">reg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">reg</span> <span class="o">=</span> <span class="n">insn</span><span class="p">.</span><span class="n">Op1</span><span class="p">.</span><span class="n">reg</span>
                        <span class="nb">sum</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span> <span class="o">+</span> <span class="n">insn</span><span class="p">.</span><span class="n">Op2</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">insn</span><span class="p">.</span><span class="n">Op1</span><span class="p">.</span><span class="n">reg</span> <span class="o">==</span> <span class="n">reg</span><span class="p">:</span>
                            <span class="nb">sum</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span> <span class="o">+</span> <span class="n">insn</span><span class="p">.</span><span class="n">Op2</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">reg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">reg</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">cmt_addr</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="nf">prev_head</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
                        <span class="nf">set_cmt</span><span class="p">(</span><span class="n">cmt_addr</span><span class="p">,</span> <span class="sh">"</span><span class="s">add %s, %Xh</span><span class="sh">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">reg_names</span><span class="p">[</span><span class="n">reg</span><span class="p">],</span> <span class="nb">sum</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">reg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    
    <span class="k">return</span>
        
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">comment_add</span><span class="p">()</span>
</pre></table></code></div></div></div></details><p><br /></p><p>The script does the simple thing: Add the comment. The result is much more better</p><p><a href="/commons/2023-06-17-hvm-solution/image013.png" class="popup img-link shimmer"><img src="/commons/2023-06-17-hvm-solution/image013.png" alt="VM" loading="lazy"></a></p><p>Now with the help of IDA, reverse engineering the vm become easier. Here is the rewritten of password checking algo (not exactly the same but at least it show how does the vm code run)</p><details> <summary><b>Click here to expand rewritten of password checking algo</b></summary><div><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">plain1</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Who controls the past controls the future. Who controls the present controls the past."</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">plain2</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"We know that no one ever seizes power with the intention of relinquishing it."</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">plain3</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Freedom is the freedom to say that two plus two make four. If that is granted, all else follows."</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">plain4</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Perhaps one did not want to be loved so much as to be understood."</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">enc1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xC4</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0x8C</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span>
    <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0x7E</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x7B</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xCD</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span>
    <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x7E</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0xB7</span><span class="p">,</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xA9</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span>
    <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0x8F</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0xA9</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">,</span> <span class="mh">0xB6</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span>
    <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0xAC</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0xC9</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x9B</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span>
    <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x8B</span>
<span class="p">};</span>

<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">enc2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0xB1</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span>
    <span class="mh">0xA4</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0xA7</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xAC</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span>
    <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span>
    <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0xDD</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0x9E</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span>
    <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x87</span>
<span class="p">};</span>

<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">enc3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0x8F</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x9E</span><span class="p">,</span> <span class="mh">0x9E</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span>
    <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0xC9</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3D</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span>
    <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0xCE</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xAE</span><span class="p">,</span>
    <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0xAC</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x7B</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x9D</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x9B</span><span class="p">,</span>
    <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xA8</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span>
    <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0xD1</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="mh">0xC5</span>
<span class="p">};</span>

<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">enc4</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xF9</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span>
    <span class="mh">0x6E</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x4E</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x8C</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="mh">0xF6</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
    <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0x2E</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="mh">0xAF</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span>
    <span class="mh">0xC9</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span>
    <span class="mh">0xA6</span>
<span class="p">};</span>

<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">plain_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">plain1</span><span class="p">,</span> <span class="n">plain2</span><span class="p">,</span> <span class="n">plain3</span><span class="p">,</span> <span class="n">plain4</span> <span class="p">};</span>
<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">enc_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">enc1</span><span class="p">,</span> <span class="n">enc2</span><span class="p">,</span> <span class="n">enc3</span><span class="p">,</span> <span class="n">enc4</span> <span class="p">};</span>
<span class="k">const</span> <span class="kt">size_t</span> <span class="n">size_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plain1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plain2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plain3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plain4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">};</span>

<span class="kt">int</span> <span class="nf">rc4</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">inbuf</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">outbuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">);</span>

<span class="n">bool</span> <span class="nf">check_password</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">password</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">rc4</span><span class="p">(</span><span class="n">plain_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">size_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">password</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">enc_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">size_array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">password</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_password</span><span class="p">(</span><span class="n">password</span><span class="p">))</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"correct"</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"wrong"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div></div></details><p><br /></p><p>Sar did a good job. He implemented whole rc4 algo in vm code. Here is a few tips to know it’s rc4:</p><ul><li>There is a loop to fill an array with value from 0 to 255<li>There is code does swap to variables</ul><h2 id="getting-the-correct-password"><span class="me-2">Getting the correct password</span><a href="#getting-the-correct-password" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now we know the vm algo. Here is the C++ code to brute force password</p><details> <summary><b>Click here to expand solution program</b></summary><div><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">plain1</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Who controls the past controls the future. Who controls the present controls the past."</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">plain2</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"We know that no one ever seizes power with the intention of relinquishing it."</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">plain3</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Freedom is the freedom to say that two plus two make four. If that is granted, all else follows."</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">plain4</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Perhaps one did not want to be loved so much as to be understood."</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">enc1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xC4</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0x8C</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span>
    <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0x7E</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x7B</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xCD</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span>
    <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x7E</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0xB7</span><span class="p">,</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xA9</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span>
    <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0x8F</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0xA9</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">,</span> <span class="mh">0xB6</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span>
    <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0xAC</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0xC9</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x9B</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span>
    <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x8B</span>
<span class="p">};</span>

<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">enc2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0xB1</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span>
    <span class="mh">0xA4</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0xA7</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xAC</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span>
    <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span>
    <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0xDD</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0x9E</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span>
    <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x87</span>
<span class="p">};</span>

<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">enc3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0x8F</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x9E</span><span class="p">,</span> <span class="mh">0x9E</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span>
    <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0xC9</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3D</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span>
    <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0xCE</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xAE</span><span class="p">,</span>
    <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0xAC</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x7B</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x9D</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x9B</span><span class="p">,</span>
    <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xA8</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span>
    <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0xD1</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="mh">0xC5</span>
<span class="p">};</span>

<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">enc4</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xF9</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span>
    <span class="mh">0x6E</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x4E</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x8C</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="mh">0xF6</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
    <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0x2E</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="mh">0xAF</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span>
    <span class="mh">0xC9</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span>
    <span class="mh">0xA6</span>
<span class="p">};</span>

<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">plain_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">plain1</span><span class="p">,</span> <span class="n">plain2</span><span class="p">,</span> <span class="n">plain3</span><span class="p">,</span> <span class="n">plain4</span> <span class="p">};</span>
<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">enc_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">enc1</span><span class="p">,</span> <span class="n">enc2</span><span class="p">,</span> <span class="n">enc3</span><span class="p">,</span> <span class="n">enc4</span> <span class="p">};</span>
<span class="k">const</span> <span class="kt">size_t</span> <span class="n">size_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plain1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plain2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plain3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plain4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">};</span>

<span class="kt">int</span> <span class="nf">rc4_x86</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">inbuf</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">outbuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">);</span>


<span class="c1">//brb{Rc4_in_4_vM}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">password</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"????????????????"</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">200</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">found_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">char1</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">char1</span> <span class="o">&lt;=</span> <span class="mh">0x7E</span><span class="p">;</span> <span class="n">char1</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">char1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">char2</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">char2</span> <span class="o">&lt;=</span> <span class="mh">0x7E</span><span class="p">;</span> <span class="n">char2</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">char2</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">char3</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">char3</span> <span class="o">&lt;=</span> <span class="mh">0x7E</span><span class="p">;</span> <span class="n">char3</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">char3</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">char4</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">char4</span> <span class="o">&lt;=</span> <span class="mh">0x7E</span><span class="p">;</span> <span class="n">char4</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">char4</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">rc4_x86</span><span class="p">(</span><span class="n">plain_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">size_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">enc_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">size_array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">password</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">;</span>
							<span class="n">found_cnt</span><span class="o">++</span><span class="p">;</span>
							<span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">password</span><span class="p">);</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">found_cnt</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
								<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">found_cnt</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Nothing found :(</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="n">exit</span><span class="o">:</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rc4_x86</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">inbuf</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">outbuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keylen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">char</span><span class="o">*</span> <span class="n">s_ptr</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">k</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">char</span><span class="o">*</span> <span class="n">k_ptr</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="kr">__asm</span> <span class="p">{</span>
		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">s_ptr</span>
		<span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="mi">256</span>
	<span class="nl">fill_s:</span>
		<span class="n">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span>
		<span class="n">sub</span> <span class="n">bl</span><span class="p">,</span> <span class="n">cl</span>
		<span class="n">mov</span><span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="n">ebx</span><span class="p">],</span> <span class="n">bl</span>
		<span class="n">loop</span> <span class="n">fill_s</span>
	<span class="p">}</span>

	<span class="c1">// Generate k</span>
	<span class="kr">__asm</span> <span class="p">{</span>
		<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="n">key</span>
		<span class="n">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="n">keylen</span><span class="p">;</span><span class="c1">//edi = size of key</span>
		<span class="n">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">k_ptr</span><span class="p">;</span><span class="c1">//esi= k;</span>
		<span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="mi">256</span>
		<span class="n">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span><span class="p">;</span><span class="c1">//ebx=j</span>
	<span class="nl">loop_j:</span>
		<span class="n">cmp</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">edi</span>
		<span class="n">jl</span> <span class="n">continue_loop</span>
		<span class="n">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span><span class="p">;</span><span class="c1">// clear ebx, move to the start of key, repeat until k is full</span>
	<span class="nl">continue_loop:</span>
		<span class="n">mov</span> <span class="n">ah</span><span class="p">,</span> <span class="p">[</span><span class="n">edx</span> <span class="o">+</span> <span class="n">ebx</span><span class="p">]</span>
		<span class="n">mov</span><span class="p">[</span><span class="n">esi</span><span class="p">],</span> <span class="n">ah</span>
		<span class="n">inc</span> <span class="n">esi</span>
		<span class="n">inc</span> <span class="n">ebx</span>
		<span class="n">loop</span> <span class="n">loop_j</span>
	<span class="p">}</span>

	<span class="c1">// Generate s</span>
	<span class="kr">__asm</span> <span class="p">{</span>
		<span class="n">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="n">s_ptr</span>
		<span class="n">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span>
		<span class="n">sub</span> <span class="n">esi</span><span class="p">,</span> <span class="mi">256</span>
		<span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
		<span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="mi">256</span>
	<span class="nl">loop_s:</span>
		<span class="n">mov</span> <span class="n">dl</span><span class="p">,</span> <span class="p">[</span><span class="n">esi</span> <span class="o">+</span> <span class="n">eax</span><span class="p">]</span>
		<span class="n">add</span> <span class="n">bl</span><span class="p">,</span> <span class="n">dl</span>
		<span class="n">mov</span> <span class="n">dl</span><span class="p">,</span> <span class="p">[</span><span class="n">edi</span> <span class="o">+</span> <span class="n">eax</span><span class="p">]</span>
		<span class="n">add</span> <span class="n">bl</span><span class="p">,</span> <span class="n">dl</span>
		<span class="n">mov</span> <span class="n">dl</span><span class="p">,</span> <span class="p">[</span><span class="n">edi</span> <span class="o">+</span> <span class="n">eax</span><span class="p">]</span>
		<span class="n">mov</span> <span class="n">dh</span><span class="p">,</span> <span class="p">[</span><span class="n">edi</span> <span class="o">+</span> <span class="n">ebx</span><span class="p">]</span>
		<span class="n">mov</span><span class="p">[</span><span class="n">edi</span> <span class="o">+</span> <span class="n">eax</span><span class="p">],</span> <span class="n">dh</span>
		<span class="n">mov</span><span class="p">[</span><span class="n">edi</span> <span class="o">+</span> <span class="n">ebx</span><span class="p">],</span> <span class="n">dl</span>
		<span class="n">inc</span> <span class="n">eax</span>
		<span class="n">loop</span> <span class="n">loop_s</span>
	<span class="p">}</span>

	<span class="kr">__asm</span> <span class="p">{</span>
		<span class="n">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">inbuf</span><span class="p">;</span><span class="c1">// esi = inbuf</span>
		<span class="n">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="n">s_ptr</span><span class="p">;</span><span class="c1">// edi = s</span>
		<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="n">outbuf</span><span class="p">;</span><span class="c1">// edx = outbuf</span>

		<span class="p">;</span><span class="c1">// clear registers</span>
		<span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
		<span class="n">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span>

		<span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">buflen</span><span class="p">;</span><span class="c1">//ecx = buflen</span>
	<span class="nl">cd:</span>
		<span class="n">push</span> <span class="n">ecx</span>
		<span class="n">movzx</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">al</span>
		<span class="n">inc</span> <span class="n">cl</span>
		<span class="n">push</span> <span class="n">edx</span>
		<span class="n">mov</span> <span class="n">dh</span><span class="p">,</span> <span class="p">[</span><span class="n">edi</span> <span class="o">+</span> <span class="n">ecx</span><span class="p">]</span>
		<span class="n">add</span> <span class="n">bl</span><span class="p">,</span> <span class="n">dh</span>
		<span class="n">mov</span> <span class="n">dl</span><span class="p">,</span> <span class="p">[</span><span class="n">edi</span> <span class="o">+</span> <span class="n">ebx</span><span class="p">]</span>
		<span class="n">mov</span><span class="p">[</span><span class="n">edi</span> <span class="o">+</span> <span class="n">ecx</span><span class="p">],</span> <span class="n">dl</span>
		<span class="n">mov</span><span class="p">[</span><span class="n">edi</span> <span class="o">+</span> <span class="n">ebx</span><span class="p">],</span> <span class="n">dh</span>
		<span class="n">add</span> <span class="n">dl</span><span class="p">,</span> <span class="n">dh</span>
		<span class="n">movzx</span> <span class="n">edx</span><span class="p">,</span> <span class="n">dl</span>
		<span class="n">mov</span> <span class="n">dl</span><span class="p">,</span> <span class="p">[</span><span class="n">edi</span> <span class="o">+</span> <span class="n">edx</span><span class="p">]</span>
		<span class="n">mov</span> <span class="n">cl</span><span class="p">,</span> <span class="p">[</span><span class="n">esi</span> <span class="o">+</span> <span class="n">eax</span><span class="p">]</span>
		<span class="n">xor</span> <span class="n">cl</span><span class="p">,</span> <span class="n">dl</span>
		<span class="n">pop</span> <span class="n">edx</span>
		<span class="n">mov</span><span class="p">[</span><span class="n">edx</span> <span class="o">+</span> <span class="n">eax</span><span class="p">],</span> <span class="n">cl</span>
		<span class="n">inc</span> <span class="n">eax</span>
		<span class="n">pop</span> <span class="n">ecx</span>
		<span class="n">loop</span> <span class="n">cd</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">buflen</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div></div></details><p><br /></p><p>To compile it, you need visual studio (I’m a guy using Windows. Don’t blame me). After about 10 minutes, the brute force code give me the correct password is <code class="language-plaintext highlighter-rouge">brb{Rc4_in_4_vM}</code></p><p><a href="/commons/2023-06-17-hvm-solution/image014.png" class="popup img-link shimmer"><img src="/commons/2023-06-17-hvm-solution/image014.png" alt="VM" loading="lazy"></a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/writeup/">Writeup</a>, <a href="/categories/reverse-engineering/">Reverse Engineering</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/crackme/" class="post-tag no-text-decoration" >crackme</a> <a href="/tags/reverse-engineering/" class="post-tag no-text-decoration" >reverse engineering</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=s4r's%20hvm%20solution%20-%20Elvis&url=https%3A%2F%2Felvisblue.github.io%2Fposts%2Fhvm-solution%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=s4r's%20hvm%20solution%20-%20Elvis&u=https%3A%2F%2Felvisblue.github.io%2Fposts%2Fhvm-solution%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=s4r's%20hvm%20solution%20-%20Elvis&url=https%3A%2F%2Felvisblue.github.io%2Fposts%2Fhvm-solution%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram" > <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recent Update</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/hvm-solution/">s4r's hvm solution</a><li class="text-truncate lh-lg"> <a href="/posts/nahamcon-mayhem-solution/">NahamCon CTF 2023 - Mayhem</a><li class="text-truncate lh-lg"> <a href="/posts/ziy-solution/">Cracking a chess engine - ziy by s4r</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/crackme/">crackme</a> <a class="post-tag btn btn-outline-primary" href="/tags/reverse-engineering/">reverse engineering</a> <a class="post-tag btn btn-outline-primary" href="/tags/ctf/">ctf</a> <a class="post-tag btn btn-outline-primary" href="/tags/dfir/">DFIR</a> <a class="post-tag btn btn-outline-primary" href="/tags/malware/">malware</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/nahamcon-mayhem-solution/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1686968340" data-df="ll" > Jun 17, 2023 </time><h4 class="pt-0 my-2">NahamCon CTF 2023 - Mayhem</h4><div class="text-muted"><p> Last weekend I spent my free time to play NahamCon CTF with idek team. We managed to get 3rd place and first blood on Mayhem challenge. Here is a quick write up for the challenge. Challenge overvi...</p></div></div></a></article><article class="col"> <a href="/posts/ziy-solution/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1688263200" data-df="ll" > Jul 2, 2023 </time><h4 class="pt-0 my-2">Cracking a chess engine - ziy by s4r</h4><div class="text-muted"><p> How to find a good crackme on crackmes.one? The answer is simple: good crackme usually created by skill reverser. ziy for example. I downloaded it 1 year ago but still have no time to try it until ...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"><div class="btn btn-outline-primary disabled" aria-label="Older"><p>-</p></div><a href="/posts/nahamcon-mayhem-solution/" class="btn btn-outline-primary" aria-label="Newer" ><p>NahamCon CTF 2023 - Mayhem</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p> © <time>2024</time> <a href="https://github.com/ElvisBlue">Elvis</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/crackme/">crackme</a> <a class="post-tag btn btn-outline-primary" href="/tags/reverse-engineering/">reverse engineering</a> <a class="post-tag btn btn-outline-primary" href="/tags/ctf/">ctf</a> <a class="post-tag btn btn-outline-primary" href="/tags/dfir/">DFIR</a> <a class="post-tag btn btn-outline-primary" href="/tags/malware/">malware</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/unregister.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
